<!doctype html><html class="theme-next pisces" lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet"><link href="//fonts.googleapis.com/css?family=Microsoft Yahei:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet"><link href="/css/main.css?v=5.1.0" rel="stylesheet"><meta name="keywords" content="Java,MyBatis,"><link rel="alternate" href="/atom.xml" title="冰封承諾" type="application/atom+xml"><link rel="shortcut icon" type="image/x-icon" href="/image/tb.png?v=5.1.0"><meta name="description" content="MyBatis 是一个 Java 持久化框架，它通过 XML 描述符或注解把对象与存储过程或 SQL 语句关联起来。MyBatis 是在 Apache 许可证  2.0 下分发的自由软件；MyBatis 的前身是 iBatis ，是 Apache 的一个开源项目"><meta name="keywords" content="Java,MyBatis"><meta property="og:type" content="article"><meta property="og:title" content="MyBatis学习笔记"><meta property="og:url" content="http://bfchengnuo.com/2017/09/28/MyBatis学习笔记/index.html"><meta property="og:site_name" content="冰封承諾"><meta property="og:description" content="MyBatis 是一个 Java 持久化框架，它通过 XML 描述符或注解把对象与存储过程或 SQL 语句关联起来。MyBatis 是在 Apache 许可证  2.0 下分发的自由软件；MyBatis 的前身是 iBatis ，是 Apache 的一个开源项目"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="http://bfchengnuo.com/image/dev/MyBatis架构.png"><meta property="og:updated_time" content="2018-08-25T09:37:28.000Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="MyBatis学习笔记"><meta name="twitter:description" content="MyBatis 是一个 Java 持久化框架，它通过 XML 描述符或注解把对象与存储过程或 SQL 语句关联起来。MyBatis 是在 Apache 许可证  2.0 下分发的自由软件；MyBatis 的前身是 iBatis ，是 Apache 的一个开源项目"><meta name="twitter:image" content="http://bfchengnuo.com/image/dev/MyBatis架构.png"><script id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Pisces",sidebar:{position:"left",display:"post",offset:12,offset_float:0,b2t:!1,scrollpercent:!1},fancybox:!0,motion:!1,duoshuo:{userId:"undefined",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://bfchengnuo.com/2017/09/28/MyBatis学习笔记/"><title>MyBatis学习笔记 | 冰封承諾</title></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><script>!function(e,a,t,n,g,c,o){e.GoogleAnalyticsObject=g,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),o=a.getElementsByTagName(t)[0],c.async=1,c.src="https://www.google-analytics.com/analytics.js",o.parentNode.insertBefore(c,o)}(window,document,"script",0,"ga"),ga("create","UA-77463916-1","auto"),ga("send","pageview")</script><div style="display:none"><script src="https://s4.cnzz.com/z_stat.php?id=1259036521&web_id=1259036521" language="JavaScript"></script></div><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">冰封承諾</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">立于浮华之世,奏响天籁之音.</p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-categories"><a href="/categories" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-about"><a href="/about" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-mark"><a href="/mark" rel="section"><i class="menu-item-icon fa fa-fw fa-retweet"></i><br>笔记本</a></li><li class="menu-item menu-item-books"><a href="/books" rel="section"><i class="menu-item-icon fa fa-fw fa-book"></i><br>书单</a></li><li class="menu-item menu-item-music"><a href="/music" rel="section"><i class="menu-item-icon fa fa-fw fa-music"></i><br>音乐台</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocapitalize="off" autocomplete="off" autocorrect="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><link itemprop="mainEntityOfPage" href="http://bfchengnuo.com/2017/09/28/MyBatis学习笔记/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Kerronex"><meta itemprop="description" content=""><meta itemprop="image" content="/image/tx.png"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="冰封承諾"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">MyBatis学习笔记</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-28T10:16:44+08:00">2017-09-28</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a></span></span> <span id="/2017/09/28/MyBatis学习笔记/" class="leancloud_visitors" data-flag-title="MyBatis学习笔记"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数</span><span class="leancloud-visitors-count"></span></span> <span class="post-meta-divider">|</span><span class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span> <span class="post-meta-item-text">字数统计</span> <span title="字数统计">5,686</span></span></div></header><div class="post-body" itemprop="articleBody"><p>MyBatis 是一个 <strong>Java 持久化框架</strong>，它通过 XML 描述符或注解把对象与存储过程或 SQL 语句关联起来。<br>MyBatis 是在 Apache 许可证 2.0 下分发的自由软件；MyBatis 的前身是 iBatis ，是 Apache 的一个开源项目<a id="more"></a><br>由于 MyBatis 是直接基于 JDBC 做了简单的映射包装，所以从性能的角度来看：<br>JDBC &gt; MyBatis &gt; hibernate</p><blockquote><p>MyBatis 是一款优秀的持久层框架，它支持定制化 SQL、存储过程以及高级映射。MyBatis 避免了几乎所有的 JDBC 代码和手动设置参数以及获取结果集。MyBatis 可以使用简单的 XML 或注解来配置和映射原生信息，将接口和 Java 的 POJOs(Plain Old Java Objects,普通的 Java对象)映射成数据库中的记录。</p></blockquote><h2 id="整体架构"><a href="#整体架构" class="headerlink" title="整体架构"></a>整体架构</h2><p>首先来看下 MyBatis 的整体架构，有一个大体的了解，相比 Hibernate 真是简单多了：</p><p><img src="/image/dev/MyBatis架构.png" alt="MyBatis架构.png"></p><p>可以看出，MyBatis 也是依赖于两类配置文件，一类是主配置文件（只有一个），一般约定命名为 <code>mybatis-config.xml</code> ，配置了运行参数、插件、连接池等信息。<br>还有就是 <code>Mapper.xml</code> 映射文件，可以有多个，里面配置的是 Statement （简单说是 SQL 也行）<br>执行的时候会通过主配置文件构建出 <strong>SqlSessionFactory</strong> ，然后获得 SqlSession 对象，利用 SqlSession 就可以操作数据库了<br>SqlSession 的底层会通过一个执行器来执行 Statement（SQL），执行器一般有两种实现，一种是基本的，一种是带有缓存功能的<br>前面说过 Statement 可以简单理解为 SQL 语句，一般我们写 SQL 语句都是用 ？占位符，所以需要输入参数，然后执行，返回执行结果，至于输入输出的类型，图上已经说的很清楚了</p><h2 id="一个入门栗子"><a href="#一个入门栗子" class="headerlink" title="一个入门栗子"></a>一个入门栗子</h2><p>了解其的最好方法就是看文档，官方有中文文档哦，首先我们需要配置基本的配置文件：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span> <span class="meta">?&gt;</span></span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE configuration</span></span><br><span class="line"><span class="meta">  PUBLIC "-//mybatis.org//DTD Config 3.0//EN"</span></span><br><span class="line"><span class="meta">  "http://mybatis.org/dtd/mybatis-3-config.dtd"&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 引入外部资源配置文件，以使用 $&#123;&#125; --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">properties</span> <span class="attr">resource</span>=<span class="string">"jdbc.properties"</span> /&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 配置环境，数据库等信息 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">environments</span> <span class="attr">default</span>=<span class="string">"development"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">environment</span> <span class="attr">id</span>=<span class="string">"development"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">"JDBC"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">"POOLED"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driver"</span> <span class="attr">value</span>=<span class="string">"$&#123;driver&#125;"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"$&#123;url&#125;"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"$&#123;username&#125;"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"$&#123;password&#125;"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">environment</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">environments</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 引入映射文件 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">"org/mybatis/example/BlogMapper.xml"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><p>上面就是主配置文件，如果是 Maven 工程，默认是在工程的 resurces 中查找映射文件，所以可以直接写文件名；<br>然后来看看映射文件应该怎么写，这个映射和 Hibernate 的可不一样，简单的多，其实就是写 SQL 语句：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span> <span class="meta">?&gt;</span></span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE mapper</span></span><br><span class="line"><span class="meta">  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"</span></span><br><span class="line"><span class="meta">  "http://mybatis.org/dtd/mybatis-3-mapper.dtd"&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.bfchengnuo"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectBlog"</span> <span class="attr">resultType</span>=<span class="string">"com.bfchengnuo.domain.Blog"</span>&gt;</span></span><br><span class="line">    select * from Blog where id = #&#123;id&#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure><p>resultType 指定的就是结果集映射到的相应的实体类，其他的先不说，看完下面的 Java 代码更好理解，下面是一段基本的 MyBatis 使用：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">String resource = <span class="string">"org/mybatis/example/mybatis-config.xml"</span>;</span><br><span class="line"><span class="comment">// Resources 是 MyBatis 提供的工具类</span></span><br><span class="line">InputStream inputStream = Resources.getResourceAsStream(resource);</span><br><span class="line">SqlSessionFactory sqlSessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(inputStream);</span><br><span class="line"></span><br><span class="line">SqlSession session = sqlSessionFactory.openSession();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  Blog blog = (Blog) session.selectOne(<span class="string">"com.bfchengnuo.selectBlog"</span>, <span class="number">101</span>);</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">  session.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后就可以看出，通过 session 的 selectOne 方法进行查询的时候是用 <code>namespace.id</code> 来定位 Statement 的</p><h2 id="添加日志支持"><a href="#添加日志支持" class="headerlink" title="添加日志支持"></a>添加日志支持</h2><p>按照上面的方法确实是可以执行，但是控制台没任何日志输出，也看不到执行的 SQL，如果想了解就需要添加日志支持，既然是日志，那就用大名鼎鼎的 log4j 了，MyBatis 是支持的，会自动检测，如果发现有 slf 就会加载的~所以只需要写个配置文件了。<br>导入依赖这个就不用说了，只要在 log4j 的配置文件中写入下面的代码即可看到效果：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">log4j.rootLogger=DEBUG,A1</span><br><span class="line">log4j.logger.org.mybatis = DEBUG</span><br><span class="line">log4j.appender.A1=org.apache.log4j.ConsoleAppender</span><br><span class="line">log4j.appender.A1.layout=org.apache.log4j.PatternLayout</span><br><span class="line">log4j.appender.A1.layout.ConversionPattern=%-d&#123;yyyy-MM-dd HH:mm:ss,SSS&#125; [%t] [%c]-[%p] %m%n</span><br></pre></td></tr></table></figure><p>简单说下意思：第一行是设置日志的等级和位置（可以随便起个名字，比如 A1），MyBatis 的许多信息都是用的 Debug 级别，可以去源码看看；<br>第二行是单独指定 MyBatis 的级别，第一行是全局的，相当于个性化设置；<br>第三行就是指定位置（A1）具体是什么，这里是控制台；<br>下面是布局和格式，d-时间；t-线程名；p-显示级别名；n-换行；<br>关于 log4j 的使用，待补充…</p><h2 id="进行CRUD操作"><a href="#进行CRUD操作" class="headerlink" title="进行CRUD操作"></a>进行CRUD操作</h2><p>下面就再深入一点，看下 MyBatis 是如何进行 CRUD 操作的：<br>首先来定义映射文件 UserMapper （习惯上，命名为 xxxMapper）：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span> <span class="meta">?&gt;</span></span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE mapper</span></span><br><span class="line"><span class="meta">  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"</span></span><br><span class="line"><span class="meta">  "http://mybatis.org/dtd/mybatis-3-mapper.dtd"&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"user"</span>&gt;</span></span><br><span class="line">	</span><br><span class="line">	<span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"queryUserById"</span> <span class="attr">resultType</span>=<span class="string">"cn.itcast.mybatis.pojo.User"</span>&gt;</span></span><br><span class="line">		SELECT *,user_name userName FROM tb_user WHERE id = #&#123;id&#125;</span><br><span class="line">	<span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">	</span><br><span class="line">	<span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"queryAll"</span> <span class="attr">resultType</span>=<span class="string">"cn.itcast.mybatis.pojo.User"</span>&gt;</span></span><br><span class="line">		SELECT *,user_name userName  FROM tb_user</span><br><span class="line">	<span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">	</span><br><span class="line">	<span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"saveUser"</span> <span class="attr">parameterType</span>=<span class="string">"cn.itcast.mybatis.pojo.User"</span>&gt;</span></span><br><span class="line">		INSERT INTO tb_user (</span><br><span class="line">			id,</span><br><span class="line">			user_name,</span><br><span class="line">			age,</span><br><span class="line">			sex,</span><br><span class="line">			updated</span><br><span class="line">		)</span><br><span class="line">		VALUES</span><br><span class="line">			(</span><br><span class="line">				NULL,</span><br><span class="line">				#&#123;userName&#125;,</span><br><span class="line">				#&#123;age&#125;,</span><br><span class="line">				#&#123;sex&#125;,</span><br><span class="line">				NOW()</span><br><span class="line">			);</span><br><span class="line">	<span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line">	</span><br><span class="line">	<span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"updateUser"</span> <span class="attr">parameterType</span>=<span class="string">"cn.itcast.mybatis.pojo.User"</span>&gt;</span></span><br><span class="line">		UPDATE tb_user</span><br><span class="line">		SET </span><br><span class="line">		 user_name = #&#123;userName&#125;,</span><br><span class="line">		 age = #&#123;age&#125;,</span><br><span class="line">		 sex = #&#123;sex&#125;,</span><br><span class="line">		 updated = NOW()</span><br><span class="line">		WHERE</span><br><span class="line">			id = #&#123;id&#125;</span><br><span class="line">	<span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line">	</span><br><span class="line">	<span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">"deleteUserById"</span> <span class="attr">parameterType</span>=<span class="string">"java.lang.Long"</span>&gt;</span></span><br><span class="line">		DELETE FROM tb_user WHERE id = #&#123;id&#125;</span><br><span class="line">	<span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure><p>一般一个 mapper 文件对应一个 Dao 层中的一些方法，一般来说方法名就是其 id，毕竟方法的执行需要 SQL 语句；注意下它们的标签就行了，下面 dao 层的具体实现也是都差不多，就是方法名和 SQL 语句的区别：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">queryUserById</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.sqlSession.selectOne(<span class="string">"user.queryUserById"</span>, id);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">queryAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.sqlSession.selectList(<span class="string">"user.queryAll"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.sqlSession.insert(<span class="string">"user.saveUser"</span>, user);</span><br><span class="line">    <span class="keyword">this</span>.sqlSession.commit();<span class="comment">//提交事务</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.sqlSession.update(<span class="string">"user.updateUser"</span>, user);</span><br><span class="line">    <span class="keyword">this</span>.sqlSession.commit();<span class="comment">//提交事务</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteUserById</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.sqlSession.delete(<span class="string">"user.deleteUserById"</span>, id);</span><br><span class="line">    <span class="keyword">this</span>.sqlSession.commit();<span class="comment">//提交事务</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>于是就会想，能不能不写这个 dao 的实现，因为感觉都是重复代码啊….最好是连映射文件也不用写…..<br>这是可能的，后面再说（<del>如果连接口都不用写那就更爽了</del>）</p><hr><p>解决字段名于属性名不一致的问题：<br>最容易想的是用别名的方式，在 SQL 语句中将字段名起一个和属性名相同的别名就可以了，例如：<code>select *,user_name userName from users</code> 就能正确映射了<br>或者直接用 MyBatis 提供的功能，在<strong>主配置</strong>文件中加入：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">settings</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"mapUnderscoreToCamelCase"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br></pre></td></tr></table></figure><p>这样貌似更简单是吧…..但是只限于驼峰命名规则，也就是：<code>A_COLUMN ===&gt; aColumn</code></p><h2 id="动态代理实现DAO"><a href="#动态代理实现DAO" class="headerlink" title="动态代理实现DAO"></a>动态代理实现DAO</h2><p>MyBatis 提供了使用动态代理的方式来实现 DAO，也就是说只需要写个 dao 的接口就行了，而不需要写具体的实现类；<br>然后先来介绍映射文件 XML 法，让我们只要配置好映射文件就不需要再写实现类：</p><ul><li>Mapper 中的 namespace 指定为接口</li><li>id 对应接口中的方法名</li><li>接口方法中的参数必须和 Mapper 中 parameterType 配置的一致（可以省略，会根据传入值进行判断）</li><li>接口方法的返回值必须和 Mapper 中 resultType 配置的一致（不可省略）</li></ul><p>满足上面四个条件应该就可以使用了，所以 dao 层接口又称为是 mapper 接口，使用的时候直接通过下面一行代码获取代理对象：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置事务自动提交</span></span><br><span class="line">SqlSession session = sqlSessionFactory.openSession(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">userDAO = sqlSession.getMapper(UserDAO.class);</span><br></pre></td></tr></table></figure><p>这样就省去了写 dao 实现类的时间，如果还想省去 XML 文件那么就需要使用注解了，它就是专门做这个的，关于注解等会再说</p><hr><p>那么为什么不需要具体的实现类呢，很显然使用的是动态代理技术；源码中有个 MapperProxy 类来做这件事，它实现了 InvocationHandler 接口，当我们调用 getMapper 方法时，就会创建出相应的一个代理对象，当我们执行这个接口的方法时就会调用 MapperProxy 中的 invoke 方法，从而不需要具体的实现类了。<br>那么它如何找到相关的 SQL 语句呢，在 MyBatis 加载主配置文件的同时，映射文件也一同加载了，如果接口和配置文件是对应的，那么就可以利用动态代理以及反射拿到接口名、方法名等数据通过方法名等找到对应的映射配置文件，也就知道对应的 SQL 语句了。<br>我们使用 getMapper 方法的时候还传入了一个类，内部通过使用泛型做了强转，所以即使是返回的代理对象我们可以直接用 UserDAO 去接收。</p><hr><p>这里的 getMapper 方法的实现应该是：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getMapper</span><span class="params">(Class&lt;T&gt; type)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> configuration.&lt;T&gt;getMapper(type, <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>它是在 DefaultSqlSession 中被定义的，可以看出深层次的调用中还传入了 this （DefaultSqlSession），这是为后面调用 selectOne、selectList 等方法做准备。<br>在 MyBatis 加载配置文件的时候（准确说是 build 的时候），就会判断映射文件配置的 namespace 是不是个接口，如果是就做为 key （class 对象），并且根据这个接口创建一个 MapperProxyFactory 对象作为值，put 进一个叫 knownMappers 的 Map 对象中去。<br>在调用 getMapper 的时候，其实就是在从这个 Map 中获取相应的代理工厂，最终通过 MapperProxyFactory 的 newInstance 方法生产出一个具体的代理对象（ MapperProxy ），其中会根据返回值而调用不同的 SQL 查询方法，调用会触发其 invoke 方法</p><h2 id="configuration常用配置"><a href="#configuration常用配置" class="headerlink" title="configuration常用配置"></a>configuration常用配置</h2><p>因为官方有中文文档，所以可以直接去看官方的详细解释，这里写几个比较常用的以便查询<br>下面的配置都是写在主配置文件里的！！</p><h3 id="属性（properties）"><a href="#属性（properties）" class="headerlink" title="属性（properties）"></a>属性（properties）</h3><p>常用它来读取外部的配置文件（properties 文件），然后用 <code>${name}</code> 来引用，让配置更加的灵活，例如可以这样定义：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span> <span class="attr">resource</span>=<span class="string">"org/mybatis/example/config.properties"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"dev_user"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"F2Fa3!33TYyg"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></figure><p>这样是不是感觉更灵活了，读取顺序是先读取 properties 中定义的，再读取指定的文件，出现重名的情况时，文件中定义的会覆盖 xml 定义的；<br>从 MyBatis 3.4.2 开始，你可以为占位符指定一个默认值，但需要先开启这个功能，详情可看官方，因为感觉用的不多就不贴了</p><h3 id="设置（settings）"><a href="#设置（settings）" class="headerlink" title="设置（settings）"></a>设置（settings）</h3><p>第一个其实已经说过了，就是解决属性名和字段名不同的问题，会自动转换的那个（mapUnderscoreToCamelCase）；<br>然后重点是这几个，后面会说到：</p><table><thead><tr><th>设置参数</th><th>描述</th><th style="text-align:left">有效值</th><th style="text-align:right">默认值</th></tr></thead><tbody><tr><td>cacheEnabled</td><td>该配置影响的所有映射器中配置的缓存的全局开关。</td><td style="text-align:left">true / false</td><td style="text-align:right">true</td></tr><tr><td>lazyLoadingEnabled</td><td>延迟加载的全局开关。当开启时，所有关联对象都会延迟加载。 特定关联关系中可通过设置<code>fetchType</code>属性来覆盖该项的开关状态。</td><td style="text-align:left">true / false</td><td style="text-align:right">false</td></tr><tr><td>aggressiveLazyLoading</td><td>当开启时，任何方法的调用都会加载该对象的所有属性。否则，每个属性会按需加载（参考<code>lazyLoadTriggerMethods</code>).</td><td style="text-align:left">true / false</td><td style="text-align:right">false (true in ≤3.4.1)</td></tr><tr><td>mapUnderscoreToCamelCase</td><td>是否开启自动驼峰命名规则（camel case）映射，即从经典数据库列名 A_COLUMN 到经典 Java 属性名 aColumn 的类似映射。</td><td style="text-align:left">true / false</td><td style="text-align:right">False</td></tr></tbody></table><h3 id="类型别名（typeAliases）"><a href="#类型别名（typeAliases）" class="headerlink" title="类型别名（typeAliases）"></a>类型别名（typeAliases）</h3><p>简单说就是把 Java 类型取一个别名，在其他地方用的时候就不需要写一大堆的包了</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">typeAliases</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">typeAlias</span> <span class="attr">alias</span>=<span class="string">"Author"</span> <span class="attr">type</span>=<span class="string">"domain.blog.Author"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">typeAlias</span> <span class="attr">alias</span>=<span class="string">"Blog"</span> <span class="attr">type</span>=<span class="string">"domain.blog.Blog"</span>/&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">&lt;!-- 可以写一个包，将会从这个包下找 JavaBean --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">"domain.blog"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">typeAliases</span>&gt;</span></span><br></pre></td></tr></table></figure><p>别名的<strong>首字母</strong>是不区分大小写的，但是习惯是大写，毕竟是类；然后 MyBatis 定义了一些默认的别名，直接用就可以了：</p><table><thead><tr><th>别名</th><th>映射的类型</th></tr></thead><tbody><tr><td>_byte</td><td>byte</td></tr><tr><td>_long</td><td>long</td></tr><tr><td>_short</td><td>short</td></tr><tr><td>_int</td><td>int</td></tr><tr><td>_integer</td><td>int</td></tr><tr><td>_double</td><td>double</td></tr><tr><td>_float</td><td>float</td></tr><tr><td>_boolean</td><td>boolean</td></tr><tr><td>string</td><td>String</td></tr><tr><td>byte</td><td>Byte</td></tr><tr><td>long</td><td>Long</td></tr><tr><td>short</td><td>Short</td></tr><tr><td>int</td><td>Integer</td></tr><tr><td>integer</td><td>Integer</td></tr><tr><td>double</td><td>Double</td></tr><tr><td>float</td><td>Float</td></tr><tr><td>boolean</td><td>Boolean</td></tr><tr><td>date</td><td>Date</td></tr><tr><td>decimal</td><td>BigDecimal</td></tr><tr><td>bigdecimal</td><td>BigDecimal</td></tr><tr><td>object</td><td>Object</td></tr><tr><td>map</td><td>Map</td></tr><tr><td>hashmap</td><td>HashMap</td></tr><tr><td>list</td><td>List</td></tr><tr><td>arraylist</td><td>ArrayList</td></tr><tr><td>collection</td><td>Collection</td></tr><tr><td>iterator</td><td>Iterator</td></tr></tbody></table><p>另外，当传入的是个数组的时候，根据源码的定义要类似这样的形式：<code>parameterType=&quot;Object[]&quot;</code> ，解析配置文件的过程中在 TypeAliasRegistry 这个类中定义了这些别名。</p><h3 id="环境（environments）"><a href="#环境（environments）" class="headerlink" title="环境（environments）"></a>环境（environments）</h3><p>前面刚开始就用到了，用它来配置的数据库信息，因为一般都有有多个环境，比如开发环境、测试环境、生产环境；每个环境的数据库是不一样，这样做是为了便于分离<br>可以使用 <code>new SqlSessionFactoryBuilder().build(reader, environment);</code> 来指定加载某个环境的配置<br>实际上，都是用 Spring 来处理这个，所以了解就好</p><h3 id="映射器（mappers）"><a href="#映射器（mappers）" class="headerlink" title="映射器（mappers）"></a>映射器（mappers）</h3><p>这个是一个重点，mappers 可以通过四种方式引用：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Using classpath relative resources --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">"org/mybatis/builder/AuthorMapper.xml"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">"org/mybatis/builder/BlogMapper.xml"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Using url fully qualified paths --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">url</span>=<span class="string">"file:///var/mappers/AuthorMapper.xml"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">url</span>=<span class="string">"file:///var/mappers/BlogMapper.xml"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Using mapper interface classes --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">class</span>=<span class="string">"org.mybatis.builder.AuthorMapper"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">class</span>=<span class="string">"org.mybatis.builder.BlogMapper"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Register all interfaces in a package as mappers --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">"org.mybatis.builder"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br></pre></td></tr></table></figure><p>第一种是比较熟的了；第二种通过绝对路径的方式基本不会用；第三种通过类引用就要必须将映射文件和接口文件放在一起，名字也要统一；第四种的包扫描方式也是如此，需要放在一起才行<br>这四种并没有想象中的那样优雅，但是好消息是，和 Spring 整合后就能使用更优雅的方式了，不用和类混在一起也不需要配置那么多 mapper，等下篇说吧</p><h2 id="Mapper常用配置"><a href="#Mapper常用配置" class="headerlink" title="Mapper常用配置"></a>Mapper常用配置</h2><p>这里所有的配置都是写在映射文件中的哦。<br>这方面官方文档中写的也是非常详细的，也是挑常用的说，SQL 映射文件有很少的几个顶级元素（按照它们应该被定义的顺序）：</p><ul><li><code>cache</code> – 给定命名空间的缓存配置。</li><li><code>cache-ref</code> – 其他命名空间缓存配置的引用。</li><li><code>resultMap</code> – 是最复杂也是最强大的元素，用来描述如何从数据库结果集中来加载对象。</li><li><code>sql</code> – 可被其他语句引用的可重用语句块。</li><li><code>insert</code> – 映射插入语句</li><li><code>update</code> – 映射更新语句</li><li><code>delete</code> – 映射删除语句</li><li><code>select</code> – 映射查询语句</li></ul><p>最后的四个其实已经用过了，对应 CRUD 操作，对它们还是有些补充的东西；<br>对于 insert/update，如果设置的是 id 自动增长，插入一条数据后是获取不到 id 的，为了让 id 回填，需要配置一些东西（下表加黑的属性）：</p><table><thead><tr><th>属性</th><th>描述</th></tr></thead><tbody><tr><td>id</td><td>命名空间中的唯一标识符，可被用来代表这条语句。</td></tr><tr><td>parameterType</td><td>将要传入语句的参数的完全限定类名或别名。这个属性是可选的，因为 MyBatis 可以通过 TypeHandler 推断出具体传入语句的参数，默认值为 unset。</td></tr><tr><td>flushCache</td><td>将其设置为 true，任何时候只要语句被调用，都会导致本地缓存和二级缓存都会被清空，默认值：true（对应插入、更新和删除语句）。</td></tr><tr><td>timeout</td><td>这个设置是在抛出异常之前，驱动程序等待数据库返回请求结果的秒数。默认值为 unset（依赖驱动）。</td></tr><tr><td>statementType</td><td>STATEMENT，PREPARED 或 CALLABLE 的一个。这会让 MyBatis 分别使用 Statement，PreparedStatement 或 CallableStatement，默认值：PREPARED。</td></tr><tr><td><strong>useGeneratedKeys</strong></td><td>（仅对 insert 和 update 有用）这会令 MyBatis 使用 JDBC 的 getGeneratedKeys 方法来取出由数据库内部生成的主键（比如：像 MySQL 和 SQL Server 这样的关系数据库管理系统的自动递增字段），默认值：false。</td></tr><tr><td><strong>keyProperty</strong></td><td>（仅对 insert 和 update 有用）唯一标记一个属性，MyBatis 会通过 getGeneratedKeys 的返回值或者通过 insert 语句的 selectKey 子元素设置它的键值，默认：<code>unset</code>。如果希望得到多个生成的列，也可以是逗号分隔的属性名称列表。</td></tr><tr><td><strong>keyColumn</strong></td><td>（仅对 insert 和 update 有用）通过生成的键值设置表中的列名，这个设置仅在某些数据库（像 PostgreSQL）是必须的，当主键列不是表中的第一列的时候需要设置。如果希望得到多个生成的列，也可以是逗号分隔的属性名称列表。</td></tr><tr><td>databaseId</td><td>如果配置了 databaseIdProvider，MyBatis 会加载所有的不带 databaseId 或匹配当前 databaseId 的语句；如果带或者不带的语句都有，则不带的会被忽略。</td></tr></tbody></table><p>简单来说是 useGeneratedKeys 开启回填 id；keyColumn 指定数据库中的列（如果和 keyProperty 相同可以省略不写）；keyProperty 指定对象中的属性名：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"insertAuthor"</span> </span></span><br><span class="line"><span class="tag">  <span class="attr">parameterType</span>=<span class="string">"Author"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">keyProperty</span>=<span class="string">"id"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">keyColumn</span>=<span class="string">"id"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">useGeneratedKeys</span>=<span class="string">"true"</span> &gt;</span></span><br></pre></td></tr></table></figure><p>这样插入以后获取 id 就是有值的</p><h3 id="resultMap"><a href="#resultMap" class="headerlink" title="resultMap"></a>resultMap</h3><p>官方给出的介绍是：是最复杂也是最强大的元素，用来描述如何从数据库结果集中来加载对象；<br>可以看出这个标签是很重要的，同时也看出了它的作用，就是来处理字段和属性之间的映射关系的，所以它也是可以处理字段名和属性名不同的问题，例如：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 定义 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">"userResultMap"</span> <span class="attr">type</span>=<span class="string">"User"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">column</span>=<span class="string">"user_id"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"username"</span> <span class="attr">column</span>=<span class="string">"user_name"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 使用 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectUser"</span> <span class="attr">resultMap</span>=<span class="string">"userResultMap"</span>&gt;</span></span><br><span class="line">  select * from user where id = #&#123;id&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><p>其中 resultMap 有一个 <strong>autoMapping</strong> 自动映射的属性，开启后如果没写的字段也会进行映射，也就是不用写全，这个默认应该是开启状态（当使用了集合等标签默认是关闭），但还是写上比较好</p><h3 id="sql片段"><a href="#sql片段" class="headerlink" title="sql片段"></a>sql片段</h3><p>sql 片段就是为了 sql 代码的复用，和 Java 代码类似，如果有很多重复的 sql 语句，可以提取出来，也便于以后的统一维护；<br>一般情况下，我们会把这些 sql 片段统一在一个单独的 mapper 文件中，就像 Java 中的工具类；下面就来看看 sql 片段的写法和使用：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">sql</span> <span class="attr">id</span>=<span class="string">"userColumns"</span>&gt;</span> $&#123;alias&#125;.id,$&#123;alias&#125;.username,$&#123;alias&#125;.password <span class="tag">&lt;/<span class="name">sql</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 使用片段 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectUsers"</span> <span class="attr">resultType</span>=<span class="string">"map"</span>&gt;</span></span><br><span class="line">  select</span><br><span class="line">    <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">"userColumns"</span>&gt;</span><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"alias"</span> <span class="attr">value</span>=<span class="string">"t1"</span>/&gt;</span><span class="tag">&lt;/<span class="name">include</span>&gt;</span>,</span><br><span class="line">    <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">"userColumns"</span>&gt;</span><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"alias"</span> <span class="attr">value</span>=<span class="string">"t2"</span>/&gt;</span><span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">  from some_table t1</span><br><span class="line">    cross join some_table t2</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><p>使用 include 标签来引用，在这其中可以使用 property 标签来指定片段中引用的值</p><h2 id="与"><a href="#与" class="headerlink" title="$与#."></a>$与#.</h2><p>在 Mapper 中，参数传递有两种方式，一种是 <code>${}</code> 另一种是 <code>#{}</code> 它们有很大的区别；</p><ul><li><code>#{}</code> 是实现的 sql 语句的预处理，之后执行的 sql 中会用 ？来代替，不需要关注数据类型（自动处理），并且能防止 SQL 注入，因为本质是占位符，所以名字其实可以随便写（<code>#{xxx}</code>），最后都会换成 ？，前提是参数是基本数据类型；</li><li><code>${}</code> 是 SQL 语句的直接拼接，不做数据类型转换，需要自行判断数据类型，不能防止 SQL 注入；</li></ul><p>当我们的表名不确定时，就可以使用 $ 了，<code>select * from ${tabName}</code> ，表名可以通过参数传递过来，如果使用 <code>#</code> 那么最终的 sql 语句就会变成：<code>select * from ?</code> ，当然会报错；<br><strong>使用 $ 时要注意的是它默认会从传入的对象中找 getter 方法获得配置的名（<code>#</code> 也是类似，但当传入的是基本数据类型时名称其实可以随便写）</strong>，例如，你传入的是一个字符串类型的表名，但是它会调用 <code>String.getTabName()</code> 方法，自然会报错，所以你知道为什么前面 CRUD 的时候一条 SQL 可以使用多次 <code>#{name}</code> 了吧。<br>解决方法有两种：</p><ul><li>使用 <code>${value}</code> ，这样就会获取默认传入的参数，它是 MyBatis 中提供的默认参数名</li><li>代码中使用注解 ( @Param )<br><code>public List&lt;Map&lt;String,Object&gt;&gt; queryByTableName(@Param(&quot;tabName&quot;) String tabName);</code></li></ul><p>还记得那张架构表么，resultType 的类型是可以设置为 Map 的，不过 Map 是个接口，需要写具体类，比如 HashMap；</p><h3 id="多个参数"><a href="#多个参数" class="headerlink" title="多个参数"></a>多个参数</h3><p>当传入的是多个参数的时候，就和 <code>#{name}</code> 中的名字有关了，但是你直接写肯定是不行的，方法也是有两种：</p><ul><li>使用 <code>#{0}</code> 、<code>#{param1}</code> 这样依次增加</li><li>代码中使用 @Param 注解，然后就可以使用 <code>#{name}</code> 的形式了</li></ul><p>优先选择的当然是注解了，这样看着比较舒服….<br>单个参数的时候 # 是与参数名无关的，最终反正会被替换成 ？</p><blockquote><p>当我们传入一个对象时，可以在 SQL 中用多个 <code>#{name}</code> 来获取对象中的属性，就像刚开始的栗子里用的一样；这种情况算是只传入了一个参数哦</p></blockquote><h3 id="使用OGNL"><a href="#使用OGNL" class="headerlink" title="使用OGNL"></a>使用OGNL</h3><p>MyBatis 默认采用的是 OGNL 表达式，所以在这里也是可以使用的，在写 SQL 的时候写的 <code>#{name}</code> 中就可以使用，还可以用在一些标签里面（比如 if 里的 test 表达式）。<br>获取几种值的写法（对大小写敏感），例如获取基本数据类型是 <code>#{_parameter}</code>：<br>获取基本类型：<code>_parameter</code><br>自定义类型：<strong>属性</strong>名<br>获取集合：数组（用 <strong>array</strong>）、List（用 <strong>list</strong> ）、Map（用 <code>_parameter</code> ）；例如：对于基本数据类型的数组：<code>array[索引]</code><br>如果是 Map 的话就是 <code>_parameter.key</code> ，自定义的类型（<code>Map&lt;string,obj&gt;</code>） 可以直接 <code>key.属性名</code> 获取</p><blockquote><p>在 OGNL 中可以直接使用 Java 中的操作符（+、-、/、==、!=、||、&amp;&amp;），以及调用 Java 中的一些方法<br>因为是写在 XML 中，所以有些符号需要转义，于是 OGNL 提供了自己的操作符代替（and、or、in、not in、mod）mod 就是取余</p></blockquote><p>所以，当 parameterType 的类型是字符串或者基本数据类型时（因为值是唯一的），并且只有一个的情况下，可以 <code>#{_parameter}</code> 也可以 <code>#{随便写点啥}</code> 或者还可以使用 OGNL 的方式直接写 <code>_parameter</code></p><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>因为 mapper 的定义可以省去写 dao 层接口实现类，所以很多情况下直接把原来的 dao 层命名为 mapper 层，原接口的命名 UserDAO 就写成了 UserMapper ，它们其实是指的一个东西，这样在使用 MyBatis 的情况下看着还是比较规范的。</p></div><div></div><div><div style="padding:10px 0;margin:20px auto;width:90%;text-align:center"><div>喜欢就请我吃包辣条吧！</div><button id="rewardButton" disable="enable" onclick='var qr=document.getElementById("QR");"none"===qr.style.display?qr.style.display="block":qr.style.display="none"'><span>赏</span></button><div id="QR" style="display:none"><div id="wechat" style="display:inline-block"><img id="wechat_qr" src="/image/pay/wx.jpg" alt="Kerronex WeChat Pay"><p>微信打赏</p></div><div id="alipay" style="display:inline-block"><img id="alipay_qr" src="/image/pay/zfb.jpg" alt="Kerronex Alipay"><p>支付宝打赏</p></div></div></div></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong> Kerronex</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="http://bfchengnuo.com/2017/09/28/MyBatis学习笔记/" title="MyBatis学习笔记">http://bfchengnuo.com/2017/09/28/MyBatis学习笔记/</a></li><li class="post-copyright-license"><strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/Java/" rel="tag"><i class="fa fa-tag"></i> Java</a><a href="/tags/MyBatis/" rel="tag"><i class="fa fa-tag"></i> MyBatis</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2017/09/22/Spring中的AOP/" rel="next" title="Spring中的AOP"><i class="fa fa-chevron-left"></i> Spring中的AOP</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/2017/09/29/Java设计模式-模板方法模式/" rel="prev" title="Java设计模式-模板方法模式">Java设计模式-模板方法模式<i class="fa fa-chevron-right"></i></a></div></div></footer></article><div class="post-spread"></div></div></div><div class="comments" id="comments"><div id="disqus_thread"><p class="warninginfo"><i class="fa fa-exclamation-triangle" aria-hidden="true"></i> 评论框加载失败，无法访问 Disqus<br><br>你可能需要魔法上网~~</p></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview">站点概览</li></ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/image/tx.png" alt="Kerronex"><p class="site-author-name" itemprop="name">Kerronex</p><p class="site-description motion-element" itemprop="description">萝莉控/程序猿<br>夜猫族/不擅长社交</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives"><span class="site-state-item-count">119</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">9</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">64</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="Mailto:bfchengnuo@gmail.com" target="_blank" title="Email"><i class="fa fa-fw fa-envelope-o"></i> Email</a></span><span class="links-of-author-item"><a href="https://GitHub.com/bfchengnuo" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i> GitHub</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-block"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-globe"></i> 小伙伴们~</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="http://heartsky.info" title="HeartSky" target="_blank">HeartSky</a></li><li class="links-of-blogroll-item"><a href="http://blog.kiuber.me" title="Kiuber" target="_blank">Kiuber</a></li><li class="links-of-blogroll-item"><a href="http://blog.csdn.net/nightcharm" title="夜Charm" target="_blank">夜Charm</a></li><li class="links-of-blogroll-item"><a href="https://bfchengnuo.com/MyRecord/#/" title="学习笔记本" target="_blank">学习笔记本</a></li><li class="links-of-blogroll-item"><a href="http://www.cnblogs.com/bfchengnuo" title="博客园" target="_blank">博客园</a></li></ul></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#整体架构"><span class="nav-number">1.</span> <span class="nav-text">整体架构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#一个入门栗子"><span class="nav-number">2.</span> <span class="nav-text">一个入门栗子</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#添加日志支持"><span class="nav-number">3.</span> <span class="nav-text">添加日志支持</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#进行CRUD操作"><span class="nav-number">4.</span> <span class="nav-text">进行CRUD操作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#动态代理实现DAO"><span class="nav-number">5.</span> <span class="nav-text">动态代理实现DAO</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#configuration常用配置"><span class="nav-number">6.</span> <span class="nav-text">configuration常用配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#属性（properties）"><span class="nav-number">6.1.</span> <span class="nav-text">属性（properties）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#设置（settings）"><span class="nav-number">6.2.</span> <span class="nav-text">设置（settings）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#类型别名（typeAliases）"><span class="nav-number">6.3.</span> <span class="nav-text">类型别名（typeAliases）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#环境（environments）"><span class="nav-number">6.4.</span> <span class="nav-text">环境（environments）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#映射器（mappers）"><span class="nav-number">6.5.</span> <span class="nav-text">映射器（mappers）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Mapper常用配置"><span class="nav-number">7.</span> <span class="nav-text">Mapper常用配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#resultMap"><span class="nav-number">7.1.</span> <span class="nav-text">resultMap</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sql片段"><span class="nav-number">7.2.</span> <span class="nav-text">sql片段</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#与"><span class="nav-number">8.</span> <span class="nav-text">$与#.</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#多个参数"><span class="nav-number">8.1.</span> <span class="nav-text">多个参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用OGNL"><span class="nav-number">8.2.</span> <span class="nav-text">使用OGNL</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#其他"><span class="nav-number">9.</span> <span class="nav-text">其他</span></a></li></ol></div></div></section></div></aside></div></main><div style="height:370px;background-image:url(/image/bj.png);background-repeat:no-repeat;margin-left:31%"></div><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright"><span id="sitetime"></span> <span class="my-face">(●'◡'●)ﾉ♥</span><script language="javascript">function siteTime(){window.setTimeout("siteTime()",1e3);var e=36e5,t=24*e,o=new Date,i=o.getFullYear(),a=o.getMonth(),n=o.getDate(),r=o.getHours(),l=o.getMinutes(),M=o.getSeconds(),s=Date.UTC(2016,3,30,8,0,0),f=Date.UTC(i,a,n,r,l,M)-s,g=Math.floor(f/31536e6),h=Math.floor(f/t-365*g),m=Math.floor(f/t),T=Math.floor((f-(365*g+h)*t)/e),u=Math.floor((f-(365*g+h)*t-T*e)/6e4),d=Math.floor((f-(365*g+h)*t-T*e-6e4*u)/1e3);document.getElementById("sitetime").innerHTML=" 本站已萌萌哒运行 "+m+" 天 "+T+" 小时 "+u+" 分钟 "+d+" 秒 "}siteTime()</script></div><div class="powered-by">由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动</div><div class="theme-info">主题 - <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a></div><div class="theme-info"><div class="powered-by"></div><span class="post-count">博客全站共428.5k字</span></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script>"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script src="/lib/jquery/index.js?v=2.1.3"></script><script src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script src="/js/src/utils.js?v=5.1.0"></script><script src="/js/src/motion.js?v=5.1.0"></script><script src="/js/src/affix.js?v=5.1.0"></script><script src="/js/src/schemes/pisces.js?v=5.1.0"></script><script src="/js/src/scrollspy.js?v=5.1.0"></script><script src="/js/src/post-details.js?v=5.1.0"></script><script src="/js/src/bootstrap.js?v=5.1.0"></script><script>var disqus_shortname="bfchengnuo",disqus_identifier="2017/09/28/MyBatis学习笔记/",disqus_title="MyBatis学习笔记";function run_disqus_script(s){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/"+s,(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}var disqus_config=function(){this.page.url=disqus_url,this.page.identifier=disqus_identifier,this.page.title=disqus_title};run_disqus_script("embed.js")</script><script>var isfetched=!1,search_path="search.xml";0==search_path.length&&(search_path="search.xml");var path="/"+search_path;function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css("overflow","hidden"),$(".popup").toggle()}var searchFunc=function(e,c,s){"use strict";$.ajax({url:e,dataType:"xml",async:!0,success:function(e){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var t=$("entry",e).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get(),a=document.getElementById(c),r=document.getElementById(s);a.addEventListener("input",function(){var u=0,d='<ul class="search-result-list">',f=this.value.trim().toLowerCase().split(/[\s\-]+/);r.innerHTML="",1<this.value.trim().length&&t.forEach(function(e){var a=!1,r=e.title.trim().toLowerCase(),c=e.content.trim().replace(/<[^>]+>/g,"").toLowerCase(),t=decodeURIComponent(e.url),s=-1,o=-1,n=-1;if(""!=r&&f.forEach(function(e,t){s=r.indexOf(e),o=c.indexOf(e),(0<=s||0<=o)&&(a=!0,0==t&&(n=o))}),a){u+=1,d+="<li><a href='"+t+"' class='search-result-title'>"+r+"</a>";var i=e.content.trim().replace(/<[^>]+>/g,"");if(0<=n){var l=n-20,p=n+80;l<0&&(l=0),0==l&&(p=50),p>i.length&&(p=i.length);var h=i.substring(l,p);f.forEach(function(e){var t=new RegExp(e,"gi");h=h.replace(t,'<b class="search-keyword">'+e+"</b>")}),d+='<p class="search-result">'+h+"...</p>"}d+="</li>"}}),d+="</ul>",0==u&&(d='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'),""==f&&(d='<div id="no-result"><i class="fa fa-search fa-5x" /></div>'),r.innerHTML=d}),proceedsearch()}})};$(".popup-trigger").click(function(e){e.stopPropagation(),0==isfetched?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(function(e){$(".popup").hide(),$(".local-search-pop-overlay").remove(),$("body").css("overflow","")}),$(".popup").click(function(e){e.stopPropagation()})</script><script src="/js/src/av-core-mini-0.6.4.js"></script><script>AV.initialize("aztA5nbwUsfTeQsa7DqnqgfF-gzGzoHsz","ri0v7p5gusNlBUnLU3A3Tq3t")</script><script>function showTime(e){var t=new AV.Query(e),c=[],u=$(".leancloud_visitors");u.each(function(){c.push($(this).attr("id").trim())}),t.containedIn("url",c),t.find().done(function(e){var t=".leancloud-visitors-count";if(0!==e.length){for(var n=0;n<e.length;n++){var o=e[n],i=o.get("url"),s=o.get("time"),r=document.getElementById(i);$(r).find(t).text(s)}for(n=0;n<c.length;n++){i=c[n],r=document.getElementById(i);var l=$(r).find(t);""==l.text()&&l.text(0)}}else u.find(t).text(0)}).fail(function(e,t){console.log("Error: "+t.code+" "+t.message)})}function addCount(i){var e=$(".leancloud_visitors"),s=e.attr("id").trim(),r=e.attr("data-flag-title").trim(),t=new AV.Query(i);t.equalTo("url",s),t.find({success:function(e){if(0<e.length){var t=e[0];t.fetchWhenSave(!0),t.increment("time"),t.save(null,{success:function(e){$(document.getElementById(s)).find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to save Visitor num, with error message: "+t.message)}})}else{var n=new i,o=new AV.ACL;o.setPublicReadAccess(!0),o.setPublicWriteAccess(!0),n.setACL(o),n.set("title",r),n.set("url",s),n.set("time",1),n.save(null,{success:function(e){$(document.getElementById(s)).find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to create")}})}},error:function(e){console.log("Error:"+e.code+" "+e.message)}})}$(function(){var e=AV.Object.extend("Counter");1==$(".leancloud_visitors").length?addCount(e):1<$(".post-title-link").length&&showTime(e)})</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });</script><script src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script src="/js/src/particle.js"></script><div id="hexo-helper-live2d"><canvas id="live2dcanvas" width="150" height="300"></canvas></div><style>#live2dcanvas{position:fixed;width:150px;height:300px;opacity:.7;right:0;z-index:999;pointer-events:none;bottom:-20px}</style><script src="/live2d/device.min.js"></script><script>const loadScript = function loadScript(c,b){var a=document.createElement("script");a.type="text/javascript";"undefined"!=typeof b&&(a.readyState?a.onreadystatechange=function(){if("loaded"==a.readyState||"complete"==a.readyState)a.onreadystatechange=null,b()}:a.onload=function(){b()});a.src=c;document.body.appendChild(a)};
(function(){
  if((typeof(device) != 'undefined') && (device.mobile())){
    document.getElementById("live2dcanvas").style.width = '75px';
    document.getElementById("live2dcanvas").style.height = '150px';
  }else
    if (typeof(device) === 'undefined') console.error('Cannot find current-device script.');
  loadScript("/live2d/script.js", function(){loadlive2d("live2dcanvas", "/live2d/assets/koharu.model.json", 0.5);});
})();</script></body></html>